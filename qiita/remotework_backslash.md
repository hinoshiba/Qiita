---
title: リモートワーク環境で、危険なURLを検出できているのだろうか
tags: Security リモートワーク セキュリティ URL バックスラッシュ
author: hinoshiba
slide: false
---
### 忙しい人へ
* リモートワークの環境によっては、社内の出口対策を経由できずに、インターネットに出る可能性があると思います
    * その場合、入り口対策をbypassできてしまうと、ちょっと危ないのではないでしょうか
    * 今回は、それをURLに限って記載した記事です
       * オリパラまでに安全なインターネットが実現されれば嬉しいなと思います
* 技術がわかる人は、[バックスラッシュの含めたURLからドメイン名が抽出できない件](https://qiita.com/hinoshiba/private/b158a8b4ca522e90fdfa#%E3%83%90%E3%83%83%E3%82%AF%E3%82%B9%E3%83%A9%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E5%90%AB%E3%82%81%E3%81%9Furl%E3%81%8B%E3%82%89%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%90%8D%E3%81%8C%E6%8A%BD%E5%87%BA%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E4%BB%B6)以降をみてください
    * 前書きや、本題の前書きが多めです

## まえがき

### リモートワークが増えていますね

* COVID-19の影響で、在宅ワーク(リモートワーク)になったツイートをよく見かけるようになりました
* 僕の知る会社のいくつかは、オリンピックパラリンピック時にもリモートワークを予定するらしいです

### リモートワーク環境はどんな感じでしょうかね

ツイッターを見ると、いろんな環境があるそうですね。

* 会社のPCをリモートで使う環境
* シンクライアントな環境
* メッセージングサービスを使う環境
* オンラインクラウドサービスを使う環境
* ...

いろいろな業務環境があるわけですが、業務通信のインターネットへの出方は大きく2つではないでしょうか？

1. VPNなどを用い、会社のネットワークを経由して、インターネットへ通信する
2. 自宅のネットワークから、インターネットへ通信する

1の場合は、会社にいるように安全な（はずの）インターネットが行えます。（安全にするProxyや、安全にするFWを経由してくれるはずですよね。）
2の場合は、安全にする機構を経由しないで、インターネットを行うケースもありそうです。
もしその状況で、怪しいサイトにアクセスしてしまったら、途中で通信を止めてくれるような機構が無いので、少し危ない気がします。

### 入り口の防御

とはいっても、多くのリモートワーク環境では、 **そもそも怪しい通信が発生しないようにする** 仕組みが存在するはずですよね。
例えば、
「アンチウイルスソフトが、PCが発生させそうな通信を検査してくれている」
「メールをPCに受信させる前に、サーバ上で、怪しいURLが存在しないか検査する」
そもそも怪しいサイトへ通信を始めなければ、途中で止めるまでもなく安全ですね。

さて、今回の記事は、その **そもそも怪しい通信が発生しないようにする仕組みに抜けがあるのじゃないか**という記事です。

## 本題

入りの防御ってちゃんと守ってくれているのだろうか。と不安になったので、ちょっとわかるURLに絞って記事にしてみます。
先ほどの例の場合、**「メールをPCに受信させる前に、サーバ上で、怪しいURLが存在しないか検査する」**が該当します。
IT関係じゃなくても読みやすいように、表現はざっくり度が高いです。

### [URL](https://ja.wikipedia.org/wiki/Uniform_Resource_Locator)は、どうやって使うのか。

例えば、以下をクリック（や、タップ）しているときです。
 「 `http://example.com/hogehoge?q=100` 」
他には、人間がわかりやすくするために、「 [リンク](http://example.com/hogehoge?q=100) 」　のように、
HTMLの`<a href="http://example.com/hogehoge?q=100">リンク</a>`を等用いたURLを人に見せない使い方もあります。

URLを使うことで、Webページ等にアクセスすることができます。
怪しいURLをクリックすれば、怪しいWebページにアクセスしてしまいます。

### URLが怪しいか安全か判断する方法の例

人間が、URLだけを見て、怪しいか安全かを判断することはやや難しいです。
なので、事前にコンピュータに判別させ、怪しいURLを手元に受信させない機構があったりします。

では、どのようにして判別するのでしょうか。

例えば、URLから抽出できる「ドメイン（インターネット上の住所を示す名前）」を調べたりします。

まずい料理店で失敗しないために、お店に入らず口コミ情報を調べることがあると思います。
ドメインも、口コミ情報のようなものと照らし合わせ、アクセスせずに怪しいかどうかある程度調べることができます。

具体例としては、サーバ上に到達したメールの本文からURLやドメインを抽出し、照らし合わせ判別させる機構等です。

### URLからドメインの抽出方法

具体的にどのようにして抽出するのか。
それは、小学校の時にやった算数の穴埋め問題の
`「 1 〇 1 = 2　」で、「＋」が入る `に近い話です。

「 `http://example.com/hogehoge?q=100` 」のドメインは、「 `example.com` 」 です。
URLは一応パターンが定まっているので、「 `http://〇〇〇/hogehoge?q=100`」の〇〇〇を抜き出せば、ドメインの取得ができます。
そのため、ルールを定めておくならば、*「2番目のスラッシュ(`/`)から、3番目のスラッシュの間」*となります。
ただルールを定めて抜き出すだけなので、やっていることは、算数の穴埋め問題に近い話です。

ちょっと余談的ですが、
コンピュータは、言葉でルールを説明しても理解してくれないので、ルールをコンピュータにわかる呪文にすることで、抽出してくれます。

```py
$ echo "http://example.com/hogehoge?q=100" | awk -F[/:] '{print $4}'
$ echo "http://example.com/hogehoge?q=100" | sed -e "s/[^/]*\/\/\([^@]*@\)\?\([^:/]*\).*/\2/"
# https://stackoverflow.com/questions/2497215/how-to-extract-domain-name-from-url
```

### バックスラッシュの含めたURLからドメイン名が抽出できない件

今回の記事の本題の、本題です。

先ほど定めた **「2番目のスラッシュ(`/`)から、3番目のスラッシュの間」** というルールで全てのURLからドメインを抽出できれば良いのですが、対応できない状況があります。

具体的には、URLの定まっていないパターンに対応できないことです。
URLには、定まっていないパターンがあり、親和性を高めるためにブラウザが自動変換してくれて使えるものがあります。
そのような自動変換元が、ドメインの抽出するルールの対象外の場合、求めるように抽出が行えません。

#### バックスラッシュ`\` (Windowsの人は `￥`にみえるやつ) が含まれるURL

定まっていない例の1つです。

例えば、ブラウザでURLを活用する場合、
「 `http://example.com/hogehoge?q=100` 」 は、
「 `http://example.com\hogehoge?q=100` 」 であっても、同じリソースへアクセスを試みます。

* 確認した環境
    * Chromium 81.0.4016.0（Developer Build） （64 ビット）
    * Google Chorome 79.0.3945.88（Official Build） （64 ビット）
    * macOS Catalina Safari バージョン13.0.4 (15608.4.9.1.3)
    * Firefox 68.3.0esr (64 ビット)
    * Opera バージョン：65.0.3467.78

さて、困ったことに、 先ほど例にあげた **「2番目のスラッシュ(`/`)から、3番目のスラッシュの間」** を活用する場合、正しくドメインを抽出できません。
本当の抽出ルールは、もう少し複雑ですが、**実は本当のルールであっても、うまく抽出されない場合が多くありました。** (興味がある人は、後述の[具体的にどう抽出されないのか。（言語別の例)](https://qiita.com/hinoshiba/private/b158a8b4ca522e90fdfa#%E5%85%B7%E4%BD%93%E7%9A%84%E3%81%AB%E3%81%A9%E3%81%86%E6%8A%BD%E5%87%BA%E3%81%95%E3%82%8C%E3%81%AA%E3%81%84%E3%81%AE%E3%81%8B%E8%A8%80%E8%AA%9E%E5%88%A5%E3%81%AE%E4%BE%8B)を参照)

### どのような影響が考えられるか

フィッシングのURL等が、入り口の防御で、正しく評価されない可能性があります。
それにより、リモートワーク等の出口対策がされきらない可能性のある環境で、問題がおきることがあるのではないでしょうか。

### この話に限定した場合に、対策としてできそうなこと

* 使う人
    * URLに、バックスラッシュが含まれていたら、怪しいのでは無いか。と気に留める
        * 多くのURLは、今回の例のような目的でバックスラッシュが使われません
            * 特定のWebサーバでは、バックスラッシュを違反としてエラーのようなものを返すものもあります
            * ただ、IISのようにバックスラッシュを受け付けるものもあるので、利用する環境と相談にはなりそうですが
        *  例`http://example.com\hogehoge?q=100`
* 開発する人
    * バックスラッシュを評価するようにしてほしい
    * もしくは、バックスラッシュを置換してから評価してほしい
* シグネチャ作る人
    * バックスラッシュも含めてほしい
    * TLD以降も評価するようにして欲しい
        * `.*\.example.com`だけじゃなくて、`.*\.example.com\\.*`や`example.com\\.*`も引っかかるようにして欲しい

#### 具体的にどう抽出されないのか。（言語別の例)

いろいろな抽出機構がどのような言語でできているか知りませんが、パッと調べた感じどれもうまく抽出してくれない

#####  Python３

```py
from urllib.parse import urlparse
test = r"http://example.com\path/eicar.txt"
parsed = urlparse(test)
print(parsed.netloc)
```
###### 結果

```
example.com\path
```

##### Java

```java
import java.util.*;
 import java.net.*;

 public class Main {
 	public static void main(String[] args) throws Exception {
 		try {
 			URL url = new URL("http://example.com\\path/eicar.txt");
 			System.out.println(url.getHost());
 		} catch (MalformedURLException e) {
 			System.out.println(e);
 		}
 	}
 }
```
###### 結果

```
example.com\path
```

##### `C#`

```csharp

using System;
 public class Test{
 	public static void Main(){
 		Uri test = new Uri("http://example.com\\path/eicar.txt");  
 		string host = test.Host;
 		System.Console.WriteLine(host);
 	}
 }
```
###### 結果

```
Unhandled Exception:
 System.UriFormatException: Invalid URI: The hostname could not be parsed.
```
# あとがき

## リモートワークって大変ですね

リモートワークとオフィス環境の差について、対応/対策に追われる方々本当お疲れ様です。
オリンピックパラリンピック期間にリモートワークになるならば、そこまでの数ヶ月間、より安全なインターネットができるよう準備が整うと嬉しいですね。(そんな私も準備する側ですが。）

## Microsoft 脆弱性報告窓口に問い合わせしてみた

余談的ですが、[マイクロソフトの日本語問い合わせが可能になったよう](https://msrc-blog.microsoft.com/2019/10/30/vulnerabilityresponsecenter/)なので、連絡してみました。

2020/01/10に、「即時修正の対象ではない。」と回答をもらいました。
が、その後のこちらの返信には応答が貰えなかったので、現在の影響有無は不明です。

我が家は、o365 businessを家族(妻と私)で利用しており、影響があるかわからないので、ちょっと不安ですね。

